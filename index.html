<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("test.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
        });



        async function updateTags() {
            getAllTags();
        }

        function setTagList(list) {
            var tagSelector = document.getElementById("tagSelector");
            tagSelector.innerHTML = "";
            for (const tag of list) {
                tagSelector.innerHTML += `<option value="${tag}">${tag}</option>`;
            }
        }

        function downloadPSU() {
            var config = [];
            var ipAddr = document.getElementById("ipAddr");
            if (ipAddr.checkValidity()) {
                config[0] = document.getElementById("480p").checked;
                config[1] = document.getElementById("modeSelector").value;
                config[2] = ipAddr.value;
            }
            var tag = document.getElementById("tagSelector").value;
            var standalone = document.getElementById("standalone").checked;
            buildPSU(tagSelector.value, standalone, config);
        }

        function generateYAML() {
            var ipAddr = document.getElementById("ipAddr");
            if (!ipAddr.checkValidity()) {
                alert("invalid IP address");
                return;
            }
            var enable480p = document.getElementById("480p").checked;
            var mode = document.getElementById("modeSelector").value;
            var config = getNHDDLConfig(enable480p, mode, ipAddr.value);
            if (config != null) {
                downloadTextFile("nhddl.yaml", config);
            }
        }

        // Thanks to https://stackoverflow.com/a/33542499
        function saveFile(filename, blob) {
            if (window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, filename);
            }
            else {
                const elem = window.document.createElement('a');
                elem.href = window.URL.createObjectURL(blob, { oneTimeOnly: true });
                elem.style.display = 'none';
                elem.download = filename;
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
            }
        }

        // Accepts base64-encoded files
        function downloadFile(filename, data) {
            const blob = new Blob([atob(data)], { type: 'application/octet-stream' });
            saveFile(filename, blob);
        }

        function downloadTextFile(filename, text) {
            const blob = new Blob([text], { type: 'application/octet-stream' });
            saveFile(filename, blob);
        }
    </script>
</head>

<body>
    <label for="tagSelector">Choose a tag:</label>
    <select name="tagSelector" id="tagSelector">
    </select>
    <br>
    Standalone: <input type="checkbox" id="standalone" />
    <br>
    <button onClick="downloadPSU()">Download PSU</button>
    <br>
    <br>
    Enable 480p in NHDDL: <input type="checkbox" id="480p" />
    <br>
    NHDDL mode:
    <select name="modeSelector" id="modeSelector">
        <option value="">Auto</option>
        <option value="ata">ATA</option>
        <option value="usb">USB</option>
        <option value="mx4sio">MX4SIO</option>
        <option value="udpbd">UDPBD</option>
        <option value="ilink">iLink</option>
    </select>
    <br>
    PS2 IP Address for UDPBD: <input type="text" id="ipAddr" minlength="7" maxlength="15" size="15"
        pattern="^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
    <br>
    <button onClick="generateYAML()" id="generateBtn">Generate nhddl.yaml</button>
</body>

</html>

<style>
    input:invalid {
        border: 2px solid red;
    }

    button:disabled {
        background-color: gray;
    }
</style>